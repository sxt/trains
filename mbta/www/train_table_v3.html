<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head>                                                                  
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta http-equiv="cache-control" content="no-cache">
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script> 
<script type="text/javascript"  src="js/train.js"></script> 
<script src="js/date.js"></script> 
<script type="text/javascript">
    $(document).ready(function() {
	var getData = function () {

	    $.ajax({
		url: "/mbta/predictions/?filter[route]=CR-Haverhill&sort=trip_id&include=vehicle",
		dataType : "json",
		cache : false,
		success : function(data) {
		    $('#trainTableBody').empty();		     	    
		    $('#trainTableBody').html("<tr colspan=\"12\"></tr>");

                    // We're only getting one 'include' - vehicle. If we ever get more, we'll need
                    // to inspect the included list elements (type attribute) to get the right included obj.
                    var vehicleData = data.included[0];

		    var predictions = data.data;
		    $.each(predictions, function(index, prediction){

                        var arrTimeStr = null;
                        if (prediction.attributes.arrival_time==null) {
                           arrTimeStr = 'N/A';
                        } else {
                           var arrTime = new Date(prediction.attributes.arrival_time);
                        
                           arrTimeStr = arrTime.toString('HH:mm');
                        }

                        var depTimeStr = null;
                        if (prediction.attributes.departure_time==null) {
                           depTimeStr = 'N/A';
                        } else {
                           var depTime = new Date(prediction.attributes.departure_time);
                        
                           depTimeStr = depTime.toString('HH:mm');
                        }

			$('#trainTable tr:last').after("<tr>"+
						       "<td>"+""+"</td>"+
						       "<td>"+prediction.relationships.trip.data.id+"</td>"+
						       "<td>"+""+"</td>"+
						       "<td>"+prediction.relationships.stop.data.id+"</td>"+
//						       "<td>"+tripObj.scheduledDate.toString('M/d/yyyy HH:mm')+"</td>"+
//						       "<td>"+tripObj.flag+"</td>"+
//						       "<td>"+tripObj.vehicle+"</td>"+
/*
						       "<td>"+tripObj.latitude+"</td>"+
						       "<td>"+tripObj.longitude+"</td>"+
						       "<td>"+tripObj.heading+"</td>"+
						       "<td>"+tripObj.speed+"</td>"+
						       "<td>"+tripObj.lateness+"</td>"+
						       "<td>"+tripObj.etaStr+"</td>"+
*/
						       "<td>"+arrTimeStr+"</td>"+
						       "<td>"+depTimeStr+"</td>"+
						       "<td>"+(prediction.relationships.vehicle.data==null? 'Unknown' : prediction.relationships.vehicle.data.id) +"</td>"+
						       "<td>"+vehicleData.attributes.latitude+"</td>"+
						       "<td>"+vehicleData.attributes.longitude+"</td>"+
						       "<td>"+vehicleData.attributes.speed+"</td>"+
						       "</tr>\n");
		    });
		},
		error : function(err) {
		    //alert(err);
		}
	    });
	};

	// Fill the table once:
        getData();
	// and then every n seconds (TEMP COMMENTED OUT):
	//setInterval(getData, 30*1000);

    });

 </script>                                                               
 </head>                                                                 
 <body>                                                                  
    <h1>MBTA Train Times: Haverhill Line</h1>
<table id="trainTable" class="table table-striped table-condensed table-hover">
<thead><tr>
      <th>TimeStamp</th>
      <th>Trip</th>
      <th>Destination</th>
      <th>Stop</th>
      <th>Arrival</th>
      <th>Departure</th>
      <th>Vehicle</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Speed</th>
      <th>Lateness</th>
      <th>ETA</th>
</tr></thead>
<tbody id="trainTableBody">
<tr colspan="12">&nbsp;</tr>
</tbody>
</table> 
 </body>                                                                 
 </html>
