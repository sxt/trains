<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
 <head>                                                                  
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<meta http-equiv="cache-control" content="no-cache">
<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script> 
<script src="js/date.js"></script> 
<script type="text/javascript">
    $(document).ready(function() {

	var getData = function () {

	    $.ajax({
		url: "http://192.168.1.7:8080/mbta/lib/RTCR/RailLine_11.xml",
		//url: "http://192.168.1.7:8080/local/mbta.xml",
		dataType : "xml",
		cache : false,
		success : function(data) {
		    $('#trainTableBody').empty();		     	    
		    $('#trainTableBody').html("<tr colspan=\"12\"></tr>");

		    $(data).find('TripMessage').each(function(){
			var timeStamp = $(this).find('TimeStamp').text();
			var timeStampDate = new Date(0);
			timeStampDate.setUTCSeconds(timeStamp);
			var trip = $(this).find('Trip').text();
			var destination = $(this).find('Destination').text();
			var stop = $(this).find('Stop').text();
			var scheduled = $(this).find('Scheduled').text();
			var scheduledDate = new Date(0);
			scheduledDate.setUTCSeconds(scheduled);
			var flag = $(this).find('Flag').text();
			var vehicle = $(this).find('Vehicle').text();
			var latitude = $(this).find('Latitude').text();
			var longitude = $(this).find('Longitude').text();
			var heading = $(this).find('Heading').text();
			var speed = $(this).find('Speed').text();
			var lateness = $(this).find('Lateness').text();
			
			var eta;
			var etaStr = "";
			if (flag == 'app') {
			    // assume approaching means current time
			    // plus 2 mins
			    eta = new Date();
			    eta.addSeconds(120);
			    etaStr = eta.toString('M/d/yyyy HH:mm');
			} else if (flag == 'arr') {
			    eta = new Date(timeStampDate);
			    etaStr = eta.toString('M/d/yyyy HH:mm');
			} else if (flag == 'dep') {
			    eta = "";
			} else if (lateness) {
			    eta = new Date(scheduledDate);
			    eta.addSeconds(lateness);
			    etaStr = eta.toString('M/d/yyyy HH:mm');
			}

			$('#trainTable tr:last').after("<tr>"+
						       "<td>"+timeStampDate.toString('M/d/yyyy HH:mm')+"</td>"+
						       "<td>"+
"<a id=\"mapLink\" target=\"_map\" href=\"map.html?locn="+latitude+","+longitude+"\">"+
trip+"</a>"+
"</td>"+
						       "<td>"+destination+"</td>"+
						       "<td>"+stop+"</td>"+
						       "<td>"+scheduledDate.toString('M/d/yyyy HH:mm')+"</td>"+
						       "<td>"+flag+"</td>"+
						       "<td>"+vehicle+"</td>"+
						       "<td>"+latitude+"</td>"+
						       "<td>"+longitude+"</td>"+
						       "<td>"+heading+"</td>"+
						       "<td>"+speed+"</td>"+
						       "<td>"+lateness+"</td>"+
						       "<td>"+etaStr+"</td>"+
						       "</tr>\n");
		    });
		},
		error : function(err) {
		    //alert(err);
		}
	    });

	};

	// Fill the table once:
        getData();
	// and then every n seconds:
	setInterval(getData, 30*1000);

    });

 </script>                                                               
 </head>                                                                 
 <body>                                                                  
    <h1>MBTA Train Times: Haverhill Line</h1>
<table id="trainTable" class="table table-striped table-condensed table-hover">
<thead><tr>
      <th>TimeStamp</th>
      <th>Trip</th>
      <th>Destination</th>
      <th>Stop</th>
      <th>Scheduled</th>
      <th>Flag</th>
      <th>Vehicle</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>Heading</th>
      <th>Speed</th>
      <th>Lateness</th>
      <th>ETA</th>
</tr></thead>
<tbody id="trainTableBody">
<tr colspan="12">&nbsp;</tr>
</tbody>
</table> 
 </body>                                                                 
 </html>
